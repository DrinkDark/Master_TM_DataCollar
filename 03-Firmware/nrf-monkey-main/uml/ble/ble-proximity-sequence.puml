@startuml
skinparam style strictuml
skinparam monochrome true
skinparam packageStyle rectangle

participant "Zephyr BLE\nStack" as S
participant "Scan Module" as SM
participant "ble_proximity.c" as PROX
database "RAM\nDouble Buffer" as BUF

== Scan window ==

S -> SM : Notify device found

activate SM
SM -> SM : Check Manufacturer Data
note right : Filter: HEI ID (0x5A02)

alt Filter match
    SM -> PROX : scanning_filter_match()
    activate PROX
    
    loop for seen_devices_count
        PROX -> PROX : bt_addr_le_cmp(device_address, seen_devices_during_scanning_period[i])
    end

    alt Device is unique
        PROX -> PROX : Parse device ID & RSSI
        PROX -> PROX : Get UTC timestamp
        
        PROX -> BUF : Store in proximity_storage_buffers[ble_write_idx]
        PROX -> PROX : Increment sample_offset
        
        alt Buffer full (512 entries)
            PROX -> PROX : Cancel flush work
            PROX -> PROX : Rotate indices (ble_write_idx)
            PROX -> PROX : k_sem_give(ble_file_access_sem)
            note right : Signal store thread
        else Buffer not full
            PROX -> PROX : Reschedule flush work (10 min)
        end
    else Duplicate
        note right of PROX : Ignore for current scan
    end
    deactivate PROX
end
deactivate SM

@enduml