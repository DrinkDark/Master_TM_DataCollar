@startuml
skinparam Monochrome true
skinparam ParticipantPadding 20
skinparam BoxPadding 10

box "Proximity Storage Thread" #F4F4F4
participant "ble_proximity_thread_store_to_file" as Store
participant "sdcard.c" as SD
end box

participant "BLE Handler" as BLE

== Idle State ==

Store -> Store : k_sem_take(ble_file_access_sem, K_FOREVER)
note left: Thread sleeps until a buffer is full\nor a flush timeout occurs

== Phase 1: File preparation & Header ==

alt is_proximity_file_opened == false
    Store -> SD : sdcard_file_setup_and_open()
    SD --> Store : Success
    
    Store -> Store : Prepare file header
    Store -> SD : fs_write(header)
end

== Phase 2: Data writing ==

Store -> Store : k_sem_take(file_access_sem, K_FOREVER)
note right: Prevents concurrent access to SD card

Store -> Store : Calculate bytes_to_write

Store -> SD : fs_write(proximity_storage_buffers[read_idx], bytes_to_write)
SD --> Store : w_res

alt w_res == -ENOMEM
    Store -> SD : sdcard_file_close()
    Store -> BLE : ble_update_status(ST_DISK_FULL)
    Store -> Store : put_device_in_power_save_mode()
else w_res != bytes_to_write
    Store -> SD : sdcard_file_close()
    Store -> BLE : ble_update_status(ST_ERROR)
    Store -> Store : put_device_in_power_save_mode()
end

== Phase 3: File rotation logic ==

Store -> Store : Calculate execution time (diff_t)
alt diff_t >= CONFIG_STORAGE_TIME_DIFF_THRESHOLD (1h)
    Store -> SD : sdcard_file_close()
end

Store -> Store : k_sem_give(file_access_sem)
@enduml